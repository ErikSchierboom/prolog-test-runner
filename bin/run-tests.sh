#! /bin/sh
set -e

# Synopsis:
# Test the test runner by running it against a predefined set of solutions 
# with an expected output.

# Output:
# Outputs the diff of the expected test results against the actual test results
# generated by the test runner.

# Example:
# ./bin/run-tests.sh

tests_dir="tests"
output_dir="tests/output"
exit_code=0

# Iterate over all test directories
for testdir in ${tests_dir}/*; do
    testdir_name="$(basename $testdir)"
    testdir_path="$(realpath $testdir)"
    expected_results_file="${testdir}/results.json"
    actual_results_file="${output_dir}/results.json"

    if [ "${testdir_name}" != output ] && [ -f "${expected_results_file}" ]; then
        bin/run.sh "${testdir_name}" "${testdir}" "${output_dir}"

        # Normalize the path to the solution in the results file
        sed -i "s~${testdir_path}~/solution~g" "${actual_results_file}"

        echo "${testdir_name}: comparing ${actual_results_file}"
        diff "${expected_results_file}" "${actual_results_file}"

        if [ $? -ne 0 ]; then
            exit_code=1
        fi
    fi
done

exit ${exit_code}
